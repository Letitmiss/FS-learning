

# NFS简介


## NFS介绍
* NFS（Network File System）即网络文件系统，是FreeBSD支持的文件系统中的一种，它允许网络中的计算机之间通过TCP/IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。    
* 它的主要功能是通过网络让不同的机器系统之间可以彼此共享文件和目录。NFS服务器可以允许NFS客户端将远端NFS服务器端的共享目录挂载到本地的NFS客户端中。在本地的NFS客户端的机器看来，NFS服务器端共享的目录就好像自己的磁盘分区和目录一样。一般客户端挂载到本地目录的名字可以随便，但为方便管理，我们要和服务器端一样比较好。


## NFS挂载结构

1 [NFS挂载结构图 ]

* 挂载说明 
1. 客户端/gx目录里面的目录最好为空,否则挂载之后会暂时丢失,卸载文件系统才会出;
2. 客户端要挂载的目录必须没有被挂载其他文件系统
3. 客户端想要存放文件成功必须服务端有把共享文件的权限打开
4. 客户端本地挂载的时候,也是有权限设置的


## 挂载原理介绍
### 基本原理
* 如上图当nfs设置号一个共享目录/gx后,其他有访问NFS服务器的客户端旧可以将这个目录挂载到本地,并且能够看到服务端/gx的所有数据。因为挂载在本地的/gx目录，其实就是服务器端的/gx目录。如果服务器端配置的客户端只读，那么客户端就只能够只读。如果配置读写，客户端就能够进行读写;挂载之后.NFS客户端可以通过磁盘命令查看挂载信息 : `df -h` 或者 `mount -l` ;
### 数据传输

* NFS是通过网络来进行服务端和客户端之间的数据传输。两者之间要传输数据就要有想对应的网络端口来进行传输。
#### NFS服务器到底使用什么网络端口来传输数据的?
1. NFS服务器端其实是随机选择端口来进行数据传输。
#### NFS客户端又是如何知道NFS服务器端到底使用的是哪个端口呢？
1. NFS服务器时通过远程过程调用（remote procedure call 简称RPC）协议/服务来实现的。RPC服务会统一管理NFS的端口，客户端和服务端通过RPC来先沟通NFS使用了哪些端口，之后再利用这些端口（小于1024）来进行数据的传输。   
2. 也就是说,RPC管理服务端的NFS端口分配，客户端要传数据，那客户端的RPC会先跟服务端的RPC去要服务器的端口，要到端口后再建立连接，然后传输数据。


## RPC远程调用
* NFS 支持的功能很多,不同的功能都会使用不同的程序来启动,每启动一个功能就会启用一些端口来传输数据,因此NFS的功能所对应的端口并不固定,而是随机的;
* PRC是linux系统化的远程调用服务,PRC最主要的功能就是指定每个NFS的功能所对应的port number,并且通知客户端,让客户端可以连接到正确的端口上去;
####  RPC如何知道每个NFS服务的端口? 
* NFS服务启动的时候会随机选取数个端口并主动向RPC注册,因此RPC可以知道没个NFS的端口,然后RPC又是固定port 111来监听客户端的需求并向客户端返回正确响应的端口,因此NFS的功能更为快捷   
> **必须谨记:在启动NFS之前,无论是客户端还是服务器端都必须先启动RPC,否则NFS会无法向RPC注册,若RPC重新启动,原来的注册数据会不见,因此重启RPC之后,它管理的所有服务都需要重新启动以向RPC注册**

#### 客户端如何服务端请求数据?
* NFS是PRc server的一种,请求服务端步骤如下:
1. 客户端会向服务端的PRC(Port 111)发出NFS的文件访问功能的查询要求
2. 服务器端找到对应的已注册的NFS daemon端口后,会通知给客户端
3. 客户端了解正确的端口后,就可以直接与NFS daemon链接

*  图解 


## NFS启动的RPC daemongs

* NFS服务器启动时至少需要两个deamons ,一个管理客户端是否能够登录的问题,一个管理客户端能够获得权限

### rpc.nfsd
* 最主要的NFS服务提供的功能,主要功能就是管理客户端是否有能够使用服务器文件系统的挂载信息等,还包含判断登录用户的ID
### rpc.mountd
 * 用于管理文件系统,当用户通过rpc.nfsd校验登录服务器之后,在操作NFS服务器提供的共享文件之前,还会经过文件权限的认证程序,会读取/etc/exports来对比客户端的权限,当权限通过之后就可以使用文件系统了;

### rpc.lockd(非必须)
* 解决多用户同时操作同一个文件,对这个文件造成问题,rpc.lockd必须客户端与服务端同时开启才可以,同是rpc.statd也同时启动

### rpc.statd(非必须)
* 检查文件的一致性,多用户同时写文件时可能造成文件损坏,rcp.lock就是检测并尝试修复该文件

> 上述几个rpc服务都写入到nfs和nfslock的服务中去了,也就是`/etc/init.d/nfs`和`/etc/init.d/nfslock`与服务端有关的设置在nfs的服务中,与客户端有关的rpc.lock设置在nfs服务中;

## NFS的文件权限

 
 









